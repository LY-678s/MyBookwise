{% extends "bookstore/base.html" %}

{% block title %}我的账户 - MyBookwise{% endblock %}

{% block content %}
<head>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    

</head>
<div class="container animate-fade-in">
    <!-- 页面标题 -->
    <div style="text-align: center; margin-bottom: 3rem;">
        <h1 style="color: var(--text-primary); font-size: 2.5rem; font-weight: 300; margin-bottom: 0.5rem;">
<span class="material-symbols-outlined" style="font-size: inherit; vertical-align: middle;" aria-hidden="true">account_circle</span>
            我的账户
        </h1>
        <p style="color: var(--text-secondary); font-size: 1.1rem;">
            管理您的个人信息和账户设置
        </p>
    </div>

    <div class="stacked" style="display:flex; flex-direction:column; gap:1.5rem;">
        <!-- 基本信息卡片 -->
        <div class="card">
            <div class="card-header">
                <h3 style="margin:0; color:var(--text-primary); display:flex; align-items:center; gap:0.5rem;">
                    <span class="material-symbols-outlined">
                        badge
                    </span>
                    基本信息
                </h3>
            </div>
            <div class="card-body">
                <div style="display:grid; gap:0.8rem;">
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:var(--text-secondary);">用户名</span>
                        <span style="font-weight:600;">{{ customer.username }}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:var(--text-secondary);">姓名</span>
                        <span style="font-weight:600;">{{ customer.name }}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:var(--text-secondary);">邮箱</span>
                        <span style="font-weight:600;">{{ customer.email|default:"未设置" }}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:var(--text-secondary);">地址</span>
                        <span style="font-weight:600;">{{ customer.address|default:"未设置" }}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:var(--text-secondary);">注册时间</span>
                        <span style="font-weight:600;">{{ customer.registerdate|date:"Y-m-d" }}</span>
                    </div>
                    <div style="margin-top:0.8rem; display:flex; gap:0.5rem;">
                        <button class="btn btn-secondary" onclick="openModal('edit-info-modal')" style="margin-right:auto;">编辑信息</button>
                        <button class="btn btn-secondary" onclick="openModal('change-password-modal')">修改密码</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 余额卡片 -->
        <div class="card">
            <div class="card-header">
                <h3 style="margin:0; color:var(--text-primary);">
                    <span class="material-symbols-outlined">
                        money_bag
                    </span>
                    账户余额
                </h3>
            </div>
            <div class="card-body">
                <div style="display:flex; flex-direction:column; gap:0.5rem;">
                    <div style="font-size:2.4rem; font-weight:300; color:{% if customer.balance < 0 %}var(--error){% else %}var(--success){% endif %};">
                        ¥{{ customer.balance }}
                    </div>
                    <div style="color:var(--text-secondary);">
                        {% if customer.balance < 0 %}欠款金额{% else %}可用余额{% endif %}
                    </div>
                    <form method="post" style="margin-top:0.5rem; display:flex; gap:0.5rem;">
                        {% csrf_token %}
                        <input type="number" name="amount" step="0.01" min="0.01" placeholder="充值金额" class="form-control" style="max-width:220px;">
                        <button type="submit" class="btn btn-success">充值</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 信用信息卡片 -->
        <div class="card">
            <div class="card-header">
                <h3 style="margin:0; color:var(--text-primary);">
                    <span class="material-symbols-outlined">
                        bar_chart
                    </span>
                    信用信息
                </h3>
            </div>
            <div class="card-body">
                <div style="display:grid; gap:0.8rem;">
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:var(--text-secondary);">当前等级</span>
                        <span style="font-weight:600; color:var(--accent);">{{ customer.levelid.levelid }}级</span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:var(--text-secondary);">累计消费</span>
                        <span style="font-weight:600;">¥{{ customer.totalspent }}</span>
                    </div>
                    {% if customer.levelid.canusecredit %}
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:var(--text-secondary);">信用额度</span>
                        <span style="font-weight:600;">
                            <span style="{% if customer.usedcredit > 0 %}color:var(--warning);{% endif %}">¥{{ customer.usedcredit|floatformat:2 }}</span>
                            <span style="color:var(--text-secondary);"> / </span>
                            ¥{{ customer.creditlimit|floatformat:2 }}
                        </span>
                    </div>
                        {% if customer.usedcredit > 0 %}
                        <div style="padding:1rem; border-radius:8px; background: var(--secondary-bg); border: 1px solid rgba(212,197,185,0.35);">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="background: rgba(244,162,97,0.12); color:#8B5A2B; font-weight:600; padding:0.35rem 0.6rem; border-radius:6px;">
                                    待还款
                                </span>
                                <span style="color:#8B5A2B; font-weight:700;">¥{{ customer.usedcredit }}</span>
                            </div>
                            <form method="post" action="{% url 'bookstore:repay_overdraft' %}" style="margin-top:0.5rem;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning" style="width:100%;">全部还款</button>
                            </form>
                        </div>
                        {% endif %}
                    {% else %}
                    <div style="color:var(--text-secondary); font-style:italic;">继续购物提升等级，解锁信用支付功能</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 快捷操作 -->
        <div class="card">
            <div class="card-header">
                <h3 style="margin:0; color:var(--text-primary);">
                    <span class="material-symbols-outlined">
                        rocket
                    </span>
                    快捷操作
                </h3>
            </div>
            <div class="card-body">
                <div style="display:flex; gap:0.75rem; flex-wrap:wrap;">
                    <a href="{% url 'bookstore:order_list' %}" class="btn btn-primary">我的订单</a>
                    <a href="{% url 'bookstore:cart_detail' %}" class="btn btn-secondary">购物车</a>
                    <a href="{% url 'bookstore:index' %}" class="btn btn-secondary">继续购物</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 信用等级说明 -->
    <div class="card" style="margin-top: 3rem;">
        <div class="card-header">
            <h3 style="margin: 0; color: var(--text-primary);">
                <span class="material-symbols-outlined">
                    info
                </span>
                信用等级说明
            </h3>
        </div>
        <div class="card-body">
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--secondary-bg);">
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid var(--border); color: var(--text-primary);">等级</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid var(--border); color: var(--text-primary);">消费要求</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid var(--border); color: var(--text-primary);">折扣率</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid var(--border); color: var(--text-primary);">信用额度</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr {% if customer.levelid.levelid == 1 %}style="background: var(--accent-light);"{% endif %}>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">1级</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">< ¥1000</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">9折</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">不可透支</td>
                        </tr>
                        <tr {% if customer.levelid.levelid == 2 %}style="background: var(--accent-light);"{% endif %}>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">2级</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">≥ ¥1000</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">8.5折</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">不可透支</td>
                        </tr>
                        <tr {% if customer.levelid.levelid == 3 %}style="background: var(--accent-light);"{% endif %}>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">3级</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">≥ ¥2000</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">8.5折</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">¥500</td>
                        </tr>
                        <tr {% if customer.levelid.levelid == 4 %}style="background: var(--accent-light);"{% endif %}>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">4级</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">≥ ¥5000</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">8折</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">¥1000</td>
                        </tr>
                        <tr {% if customer.levelid.levelid == 5 %}style="background: var(--accent-light);"{% endif %}>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">5级</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">≥ ¥10000</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">7.5折</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">几乎无限</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--secondary-bg); border-radius: 8px;">
                <p style="margin: 0; color: var(--text-primary);">
                    <span class="material-symbols-outlined">
                        info
                    </span>
                    您当前是 <strong>{{ customer.levelid.levelid }}级会员</strong>，
                    累计消费 <strong>¥{{ customer.totalspent }}</strong>
                    {% if customer.levelid.levelid < 5 %}
                        ，距离下一级还需 <strong>¥{{ next_level_amount|default:"计算中..." }}</strong>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- 编辑信息弹窗 -->
    <div id="edit-info-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0; color: var(--text-primary);">
                    <span class="material-symbols-outlined">
                        edit
                        </span>
                    编辑个人信息
                </h3>
                <button class="modal-close" onclick="closeModal('edit-info-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'bookstore:account_edit' %}">
                    {% csrf_token %}
                    <div style="display: grid; gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 500;">用户名</label>
                            <input type="text" value="{{ customer.username }}" readonly class="form-control" style="background: var(--secondary-bg);">
                            <small style="color: var(--text-secondary);">用户名不可修改</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 500;">姓名 *</label>
                            <input type="text" name="name" value="{{ customer.name }}" required class="form-control">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 500;">邮箱 *</label>
                            <input type="email" name="email" value="{{ customer.email }}" required class="form-control">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 500;">地址</label>
                            <input type="text" name="address" value="{{ customer.address }}" class="form-control">
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('edit-info-modal')">取消</button>
                        <button type="submit" class="btn btn-primary">保存修改</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 修改密码弹窗 -->
    <div id="change-password-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0; color: var(--text-primary);">
                    <span class="material-symbols-outlined">
                        lock
                    </span>
                    修改密码
                </h3>
                <button class="modal-close" onclick="closeModal('change-password-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'bookstore:account_edit' %}">
                    {% csrf_token %}
                    <div style="display: grid; gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 500;">当前密码 *</label>
                            <input type="password" name="current_password" required class="form-control">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 500;">新密码 *</label>
                            <input type="password" name="new_password" required minlength="6" class="form-control">
                            <small style="color: var(--text-secondary);">密码长度至少6位</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 500;">确认新密码 *</label>
                            <input type="password" name="confirm_password" required minlength="6" class="form-control">
                        </div>
                        <!-- 隐藏字段用于更新基本信息（保持不变） -->
                        <input type="hidden" name="name" value="{{ customer.name }}">
                        <input type="hidden" name="email" value="{{ customer.email }}">
                        <input type="hidden" name="address" value="{{ customer.address }}">
                    </div>
                    <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('change-password-modal')">取消</button>
                        <button type="submit" class="btn btn-primary">修改密码</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// 弹窗控制函数
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // 防止背景滚动
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto'; // 恢复滚动
    }
}

// 点击弹窗背景关闭弹窗
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal-overlay')) {
        event.target.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
});

// ESC键关闭弹窗
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach(modal => {
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });
    }
});

// 页面加载时的初始化
document.addEventListener('DOMContentLoaded', function() {
    // 为按钮添加动画效果
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px) scale(1.02)';
        });

        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });
});
</script>

<style>
/* 弹窗样式 */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease-out;
}

.modal-content {
    background: white;
    border-radius: 8px;
    border: 1px solid var(--border, #e1e5e9);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideIn 0.3s ease-out;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border, #e1e5e9);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-secondary, #6c757d);
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: var(--secondary-bg, #f8f9fa);
    color: var(--text-primary, #212529);
}

.modal-body {
    padding: 1.5rem;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* 响应式调整 */
@media (max-width: 768px) {
    .grid-2 {
        grid-template-columns: 1fr;
    }

    .card-body table {
        font-size: 0.8rem;
    }

    .card-body table th,
    .card-body table td {
        padding: 0.5rem;
    }

    .modal-content {
        width: 95%;
        margin: 1rem;
    }

    .modal-header,
    .modal-body {
        padding: 1rem;
    }
}
</style>

 

<div style="margin-top: 2rem;">
    <a href="{% url 'bookstore:order_list' %}" class="btn">返回订单列表</a>
</div>

{% endblock %}

