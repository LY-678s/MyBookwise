{% extends "bookstore/base.html" %}
{% block content %}
<head>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
</head>
<div class="container animate-fade-in">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div style="text-align: center; margin-bottom: 3rem;">
        <h1 style="color: var(--text-primary); font-size: 2.5rem; font-weight: 300; margin-bottom: 0.5rem;">
            ç¡®è®¤è®¢å•
        </h1>
        <p style="color: var(--text-secondary); font-size: 1.1rem;">
            è¯·ç¡®è®¤è®¢å•ä¿¡æ¯å¹¶é€‰æ‹©æ”¯ä»˜æ–¹å¼
        </p>
    </div>

    {% if customer %}
    <!-- è´¦æˆ·ä¿¡æ¯å¡ç‰‡ -->
    <div class="card" style="margin-bottom: 3rem;">
        <div class="card-header">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-symbols-outlined">
                    id_card
                </span>
                è´¦æˆ·ä¿¡æ¯
            </h3>
        </div>
        <div class="card-body">
            <div class="grid grid-3">
                <div style="text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">ä¼šå‘˜ç­‰çº§</div>
                    <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent);">
                        {{ customer.levelid.levelid }}çº§
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">
                        {{ discount_percent|floatformat:0 }}% ä¼˜æƒ 
                    </div>
                </div>

                <div style="text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">è´¦æˆ·ä½™é¢</div>
                    <div style="font-size: 1.5rem; font-weight: 600;
                         color: {% if customer.balance < 0 %}var(--error){% else %}var(--success){% endif %}">
                        Â¥{{ customer.balance }}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">
                        {% if customer.balance < 0 %}æ¬ æ¬¾{% else %}å¯ç”¨{% endif %}
                    </div>
                </div>

                {% if customer.levelid.canusecredit %}
                <div style="text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">ä¿¡ç”¨é¢åº¦</div>
                    <div style="font-size: 1.5rem; font-weight: 600; color: var(--warning);">
                        Â¥{{ customer.creditlimit|add:"-"|add:customer.usedcredit|floatformat:2 }}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">
                        å¯ç”¨é¢åº¦
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- è®¢å•å•†å“åˆ—è¡¨ -->
    <div class="card" style="margin-bottom: 3rem;">
        <div class="card-header">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-symbols-outlined icon-md" role="img" aria-label="å¿«é€’ç›’">
                    box
                </span> 
                è®¢å•å•†å“
            </h3>
        </div>
        <div class="card-body">
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--secondary-bg);">
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid var(--border); color: var(--text-primary);">å›¾ä¹¦</th>
                            <th style="padding: 1rem; text-align: center; border-bottom: 2px solid var(--border); color: var(--text-primary);">æ•°é‡</th>
                            <th style="padding: 1rem; text-align: center; border-bottom: 2px solid var(--border); color: var(--text-primary);">å•ä»·</th>
                            <th style="padding: 1rem; text-align: center; border-bottom: 2px solid var(--border); color: var(--text-primary);">æŠ˜æ‰£å</th>
                            <th style="padding: 1rem; text-align: center; border-bottom: 2px solid var(--border); color: var(--text-primary);">å°è®¡</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <!-- å›¾ä¹¦å°é¢ -->
                                    <div style="width: 50px; height: 70px; background: var(--accent-light);
                                         border-radius: 4px; display: flex; align-items: center; justify-content: center;
                                         flex-shrink: 0;">
                                        {% if item.book.coverimage %}
                                            <img src="data:image/jpeg;base64,{{ item.book.coverimage|safe }}"
                                                 alt="{{ item.book.title }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">
                                        {% else %}
                                            <span style="font-size: 1.5rem;">
                                                <span class="material-symbols-outlined">
                                                    book
                                                </span>
                                            </span>
                                        {% endif %}
                                    </div>
                                    <!-- å›¾ä¹¦ä¿¡æ¯ -->
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">
                                            {{ item.book.title }}
                                        </div>
                                        <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                            ISBN: {{ item.book.isbn }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td style="padding: 1rem; text-align: center; font-weight: 600;">
                                {{ item.quantity }}
                            </td>
                            <td style="padding: 1rem; text-align: center; color: var(--text-secondary);">
                                Â¥{{ item.book.price }}
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                {% if discount_percent < 100 %}
                                <span style="color: var(--error); font-weight: 600;">
                                    Â¥{{ item.discounted_price|floatformat:2 }}
                                </span>
                                {% else %}
                                <span>Â¥{{ item.book.price }}</span>
                                {% endif %}
                            </td>
                            <td style="padding: 1rem; text-align: center; font-weight: 700; color: var(--text-primary);">
                                Â¥{{ item.discounted_amount|floatformat:2 }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr style="background: var(--secondary-bg);">
                            <td colspan="4" style="padding: 1rem; text-align: right; font-weight: 600; color: var(--text-primary);">
                                å•†å“æ€»ä»·ï¼š
                            </td>
                            <td style="padding: 1rem; text-align: center; font-weight: 700; color: var(--text-primary);">
                                Â¥{{ original_total|floatformat:2 }}
                            </td>
                        </tr>
                        {% if discount_amount > 0 %}
                        <tr>
                            <td colspan="4" style="padding: 1rem; text-align: right; font-weight: 600; color: var(--success);">
                                ä¼˜æƒ èŠ‚çœï¼š
                            </td>
                            <td style="padding: 1rem; text-align: center; font-weight: 700; color: var(--success);">
                                -Â¥{{ discount_amount|floatformat:2 }}
                            </td>
                        </tr>
                        {% endif %}
                        <tr style="background: var(--accent-light); border-top: 2px solid var(--accent);">
                            <td colspan="4" style="padding: 1rem; text-align: right; font-weight: 700; font-size: 1.1rem; color: var(--text-primary);">
                                åº”ä»˜é‡‘é¢ï¼š
                            </td>
                            <td style="padding: 1rem; text-align: center; font-weight: 700; font-size: 1.2rem; color: var(--error);">
                                Â¥{{ discounted_total|floatformat:2 }}
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- å‘è´§åœ°å€ -->
    <div class="card" style="margin-bottom: 3rem;">
        <div class="card-header">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                å‘è´§åœ°å€
                <button class="btn btn-secondary" onclick="toggleAddressEdit()"
                        style="margin-left: auto; padding: 0.25rem 0.75rem; font-size: 0.8rem;">
                ç¼–è¾‘
                </button>
            </h3>
        </div>
        <div class="card-body">
            <!-- æ˜¾ç¤ºåœ°å€ -->
            <div id="address-display">
                <div style="padding: 1rem; background: var(--secondary-bg); border-radius: 8px;">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        {{ customer.name }} ({{ customer.username }})
                    </div>
                    <div style="color: var(--text-secondary);">
                        {{ customer.email }}<br>
                        {{ customer.address|default:"æœªè®¾ç½®åœ°å€ï¼Œè¯·ç¼–è¾‘åå¡«å†™" }}
                    </div>
                </div>
            </div>

            <!-- ç¼–è¾‘åœ°å€ -->
            <div id="address-edit" style="display: none;">
                <form id="address-form" style="display: grid; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">æ”¶è´§äººå§“å</label>
                        <input type="text" class="form-control" name="shipping_name" value="{{ customer.name }}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è”ç³»ç”µè¯/é‚®ç®±</label>
                        <input type="text" class="form-control" name="shipping_contact" value="{{ customer.email }}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è¯¦ç»†åœ°å€</label>
                        <textarea class="form-control" name="shipping_address" rows="3" required>{{ customer.address }}</textarea>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-primary" onclick="saveAddress()">ä¿å­˜åœ°å€</button>
                        <button type="button" class="btn btn-secondary" onclick="toggleAddressEdit()">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ”¯ä»˜æ–¹å¼é€‰æ‹© -->
    <div class="card" style="margin-bottom: 3rem;">
        <div class="card-header">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <span>ğŸ’³</span> é€‰æ‹©æ”¯ä»˜æ–¹å¼
            </h3>
        </div>
        <div class="card-body">
            <form method="post" id="order-form">
                {% csrf_token %}

                <!-- ä½™é¢æ”¯ä»˜é€‰é¡¹ -->
                <label class="payment-option" style="display: block; margin-bottom: 1rem;">
                    <input type="radio" name="payment_choice" value="balance" checked style="margin-right: 0.5rem;">
                    <div class="payment-card" style="border: 2px solid var(--success); background: linear-gradient(135deg, rgba(168, 218, 220, 0.1) 0%, rgba(184, 216, 216, 0.1) 100%);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2rem;">
                                <span class="material-symbols-outlined">
                                    money_bag
                                </span>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--success);">ä½™é¢æ”¯ä»˜</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                                    æ”¯ä»˜é‡‘é¢ï¼šÂ¥{{ discounted_total|floatformat:2 }}
                                    {% if customer.balance >= discounted_total %}
                                        <br><span style="color: var(--success);">âœ“ ä½™é¢å……è¶³ï¼Œå…¨éƒ¨ä»ä½™é¢æ‰£æ¬¾</span>
                                    {% else %}
                                        <br><span style="color: var(--warning);">âš  ä½™é¢ä¸è¶³ï¼Œ</span>
                                        {% if customer.levelid.canusecredit %}
                                            <span style="color: var(--accent);">å…ˆç”¨ä½™é¢(Â¥{{ customer.balance }})ï¼Œå‰©ä½™ä½¿ç”¨ä¿¡ç”¨é¢åº¦</span>
                                        {% else %}
                                            <span style="color: var(--error);">è¯¥ç­‰çº§ä¸æ”¯æŒä¿¡ç”¨ï¼Œè¯·å……å€¼</span>
                                        {% endif %}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </label>

                <!-- ä¿¡ç”¨æ”¯ä»˜é€‰é¡¹ï¼ˆä»…3-5çº§ï¼‰ -->
                {% if customer.levelid.canusecredit %}
                <label class="payment-option" style="display: block;">
                    <input type="radio" name="payment_choice" value="credit" style="margin-right: 0.5rem;">
                    <div class="payment-card" style="border: 2px solid var(--accent); background: linear-gradient(135deg, rgba(212, 197, 185, 0.1) 0%, rgba(232, 224, 216, 0.1) 100%);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2rem;">
                                <span class="material-symbols-outlined">
                                    credit_card
                                </span>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--accent);">ä¿¡ç”¨æ”¯ä»˜</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                                    ä¸ä½¿ç”¨ä½™é¢ï¼Œå…¨éƒ¨ä½¿ç”¨ä¿¡ç”¨é¢åº¦ Â¥{{ discounted_total|floatformat:2 }}
                                    <br>
                                    å¯ç”¨é¢åº¦ï¼šÂ¥{{ customer.creditlimit|add:"-"|add:customer.usedcredit|floatformat:2 }}ï¼Œ
                                    å·²ä½¿ç”¨ï¼šÂ¥{{ customer.usedcredit|floatformat:2 }}
                                </p>
                            </div>
                        </div>
                    </div>
                </label>
                {% endif %}

                <!-- éšè—çš„å‘è´§åœ°å€å­—æ®µ -->
                <input type="hidden" name="shipping_name" value="{{ customer.name }}">
                <input type="hidden" name="shipping_contact" value="{{ customer.email }}">
                <input type="hidden" name="shipping_address" value="{{ customer.address }}">
            </form>
        </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="card">
        <div class="card-body">
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button type="submit" form="order-form" class="btn btn-primary" style="padding: 1rem 3rem; font-size: 1.1rem;">
                    ç¡®è®¤ä¸‹å•
                </button>
                <a href="{% url 'bookstore:cart_detail' %}" class="btn btn-secondary" style="padding: 1rem 3rem;">
                    è¿”å›è´­ç‰©è½¦
                </a>
            </div>

            <div style="margin-top: 2rem; padding: 1rem; background: var(--secondary-bg); border-radius: 8px;">
                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem; text-align: center;">
                    <span class="material-symbols-outlined">
                        emoji_objects
                        </span>
                    æç¤ºï¼š
                    {% if customer.levelid.canusecredit %}
                        æ‚¨æ˜¯{{ customer.levelid.levelid }}çº§ä¼šå‘˜ï¼Œæ”¯æŒä¿¡ç”¨æ”¯ä»˜ã€‚æœªå…¨é¢æ”¯ä»˜çš„è®¢å•éœ€åœ¨30å¤©å†…å®Œæˆæ”¯ä»˜ã€‚
                    {% else %}
                        æ‚¨å½“å‰æ˜¯{{ customer.levelid.levelid }}çº§ä¼šå‘˜ï¼Œæš‚ä¸æ”¯æŒä¿¡ç”¨æ”¯ä»˜åŠŸèƒ½ï¼Œåªèƒ½ä½¿ç”¨ä½™é¢æ”¯ä»˜ã€‚
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<script>
function toggleAddressEdit() {
    const display = document.getElementById('address-display');
    const edit = document.getElementById('address-edit');

    if (display.style.display !== 'none') {
        display.style.display = 'none';
        edit.style.display = 'block';
    } else {
        display.style.display = 'block';
        edit.style.display = 'none';
    }
}

function saveAddress() {
    const form = document.getElementById('address-form');
    const formData = new FormData(form);

    // æ›´æ–°è¡¨å•ä¸­çš„éšè—å­—æ®µ
    document.querySelector('input[name="shipping_name"]').value = formData.get('shipping_name');
    document.querySelector('input[name="shipping_contact"]').value = formData.get('shipping_contact');
    document.querySelector('input[name="shipping_address"]').value = formData.get('shipping_address');

    // æ›´æ–°æ˜¾ç¤ºåŒºåŸŸ
    document.querySelector('#address-display .card-body').innerHTML = `
        <div style="padding: 1rem; background: var(--secondary-bg); border-radius: 8px;">
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                ${formData.get('shipping_name')} (${document.querySelector('input[name="shipping_name"]').value})
            </div>
            <div style="color: var(--text-secondary);">
                ${formData.get('shipping_contact')}<br>
                ${formData.get('shipping_address')}
            </div>
        </div>
    `;

    toggleAddressEdit();

    // æ˜¾ç¤ºä¿å­˜æˆåŠŸçš„æç¤º
    showMessage('åœ°å€ä¿¡æ¯å·²æ›´æ–°', 'success');
}

function showMessage(message, type) {
    // åˆ›å»ºæ¶ˆæ¯æç¤º
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.textContent = message;
    messageDiv.style.position = 'fixed';
    messageDiv.style.top = '20px';
    messageDiv.style.right = '20px';
    messageDiv.style.zIndex = '1000';

    document.body.appendChild(messageDiv);

    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

// æ”¯ä»˜é€‰é¡¹ç‚¹å‡»æ•ˆæœ
document.querySelectorAll('.payment-option').forEach(option => {
    option.addEventListener('click', function() {
        // ç§»é™¤å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.payment-card').forEach(card => {
            card.style.boxShadow = '0 4px 12px var(--shadow)';
        });

        // ä¸ºå½“å‰é€‰é¡¹æ·»åŠ é€‰ä¸­æ•ˆæœ
        const card = this.querySelector('.payment-card');
        card.style.boxShadow = '0 8px 24px rgba(212, 197, 185, 0.3)';
    });
});

// é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æ¨¡æ‹Ÿå›¾ä¹¦å°é¢å›¾ç‰‡å¤„ç†
    document.querySelectorAll('img').forEach(img => {
        img.onerror = function() {
            this.style.display = 'none';
            this.nextElementSibling.style.display = 'flex';
        };
    });
});
</script>

<style>
.payment-card {
    padding: 1.5rem;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.payment-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px var(--shadow);
}

.payment-option input[type="radio"] {
    transform: scale(1.2);
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .grid-3 {
        grid-template-columns: 1fr;
    }

    table {
        font-size: 0.8rem;
    }

    table th, table td {
        padding: 0.5rem;
    }
}
</style>

<p style="color: #7f8c8d; margin-top: 1rem; font-size: 0.9rem;">
    <span class="material-symbols-outlined">
        emoji_objects
        </span>
    æç¤ºï¼š
    {% if customer.levelid.canusecredit %}
        æ‚¨æ˜¯{{ customer.levelid.levelid }}çº§ä¼šå‘˜ï¼Œæ”¯æŒä¿¡ç”¨æ”¯ä»˜ã€‚æœªå…¨é¢æ”¯ä»˜çš„è®¢å•éœ€åœ¨30å¤©å†…å®Œæˆæ”¯ä»˜ã€‚
    {% else %}
        æ‚¨å½“å‰æ˜¯{{ customer.levelid.levelid }}çº§ä¼šå‘˜ï¼Œæš‚ä¸æ”¯æŒä¿¡ç”¨æ”¯ä»˜åŠŸèƒ½ï¼Œåªèƒ½ä½¿ç”¨ä½™é¢æ”¯ä»˜ã€‚
    {% endif %}
</p>
{% endblock %}