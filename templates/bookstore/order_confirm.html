{% extends "bookstore/base.html" %}
{% block content %}
<h2>ç¡®è®¤è®¢å•</h2>

{% if customer %}
<div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
  <p><strong>å½“å‰ä¼šå‘˜ç­‰çº§ï¼š{{ customer.levelid.levelid }}çº§</strong> | æŠ˜æ‰£ç‡ï¼š{{ discount_percent|floatformat:0 }}% ä¼˜æƒ </p>
  <p><strong>è´¦æˆ·ä½™é¢ï¼š</strong>
    <span style="{% if customer.balance < 0 %}color: #e74c3c;{% else %}color: #27ae60;{% endif %} font-weight: bold;">
      Â¥{{ customer.balance }}
    </span>
    {% if customer.levelid.canoverdraft %}
      | <strong>å¯ç”¨é€æ”¯é¢åº¦ï¼š</strong>Â¥{{ customer.overdraftlimit|floatformat:2 }}
      ï¼ˆå½“å‰å·²é€æ”¯ï¼šÂ¥{{ customer.currentoverdraft|floatformat:2 }}ï¼‰
    {% endif %}
  </p>
</div>
{% endif %}

<table border="1" cellpadding="10" style="width: 100%; border-collapse: collapse;">
  <thead>
    <tr>
      <th>å›¾ä¹¦</th>
      <th>æ•°é‡</th>
      <th>å•ä»·</th>
      <th>åŸå§‹å°è®¡</th>
      <th>æŠ˜æ‰£åå°è®¡</th>
    </tr>
  </thead>
  <tbody>
    {% for item in items %}
      <tr>
        <td>{{ item.book.title }}</td>
        <td>{{ item.quantity }}</td>
        <td>Â¥{{ item.book.price }}</td>
        <td>Â¥{{ item.original_amount|floatformat:2 }}</td>
        <td><strong>Â¥{{ item.discounted_amount|floatformat:2 }}</strong></td>
      </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <td colspan="3"><strong>åˆè®¡</strong></td>
      <td>Â¥{{ original_total|floatformat:2 }}</td>
      <td><strong>Â¥{{ discounted_total|floatformat:2 }}</strong></td>
    </tr>
    <tr>
      <td colspan="3"><strong>èŠ‚çœé‡‘é¢</strong></td>
      <td colspan="2" style="color: green;"><strong>Â¥{{ discount_amount|floatformat:2 }}</strong></td>
    </tr>
  </tfoot>
</table>

<div style="background: white; border: 2px solid #3498db; border-radius: 8px; padding: 1.5rem; margin-top: 1.5rem;">
  <h3 style="margin-top: 0; color: #2c3e50;">é€‰æ‹©ä»˜æ¬¾æ–¹å¼</h3>
  
  <form method="post">
    {% csrf_token %}
    
    <div style="margin-bottom: 1.5rem;">
      <!-- ç«‹å³ä»˜æ¬¾ï¼ˆæ‰€æœ‰ç­‰çº§éƒ½æ”¯æŒï¼‰ -->
      <label style="display: block; padding: 1rem; border: 2px solid #27ae60; border-radius: 8px; margin-bottom: 1rem; cursor: pointer; background: #e8f5e9;">
        <input type="radio" name="payment_method" value="immediate" checked style="margin-right: 0.5rem;">
        <strong style="color: #27ae60;">ğŸ’³ ç«‹å³ä»˜æ¬¾</strong>
        <p style="margin: 0.5rem 0 0 1.5rem; color: #555; font-size: 0.9rem;">
          ç«‹å³æ‰£æ¬¾ Â¥{{ discounted_total|floatformat:2 }}
          {% if customer.balance >= discounted_total %}
            <span style="color: #27ae60;">âœ“ ä½™é¢å……è¶³</span>
          {% else %}
            {% if customer.levelid.canoverdraft %}
              <span style="color: #f39c12;">âš  ä½™é¢ä¸è¶³ï¼Œå°†ä½¿ç”¨é€æ”¯é¢åº¦</span>
            {% else %}
              <span style="color: #e74c3c;">âœ— ä½™é¢ä¸è¶³ï¼Œè¯·å……å€¼</span>
            {% endif %}
          {% endif %}
        </p>
      </label>
      
      <!-- æš‚ç¼“ä»˜æ¬¾ï¼ˆä»…3-5çº§ï¼‰ -->
      {% if customer.levelid.canoverdraft %}
      <label style="display: block; padding: 1rem; border: 2px solid #3498db; border-radius: 8px; cursor: pointer; background: #e3f2fd;">
        <input type="radio" name="payment_method" value="defer" style="margin-right: 0.5rem;">
        <strong style="color: #3498db;">â³ æš‚ç¼“ä»˜æ¬¾</strong>
        <p style="margin: 0.5rem 0 0 1.5rem; color: #555; font-size: 0.9rem;">
          ä¸ç«‹å³æ‰£æ¬¾ï¼Œè®¢å•é‡‘é¢ Â¥{{ discounted_total|floatformat:2 }} è®¡å…¥é€æ”¯é¢åº¦
          <br>
          å¯ç”¨é€æ”¯é¢åº¦ï¼šÂ¥{{ customer.overdraftlimit|floatformat:2 }}ï¼Œ
          å½“å‰å·²ç”¨ï¼šÂ¥{{ customer.currentoverdraft|floatformat:2 }}
        </p>
      </label>
      {% endif %}
    </div>
    
    <div style="display: flex; gap: 1rem;">
      <button type="submit" class="btn btn-success" style="padding: 0.75rem 2rem; font-size: 1.1rem;">
        ç¡®è®¤ä¸‹å•
      </button>
      <a href="{% url 'bookstore:cart_detail' %}" class="btn" style="padding: 0.75rem 2rem;">
        è¿”å›è´­ç‰©è½¦
      </a>
    </div>
  </form>
</div>

<p style="color: #7f8c8d; margin-top: 1rem; font-size: 0.9rem;">
  ğŸ’¡ æç¤ºï¼š
  {% if customer.levelid.canoverdraft %}
    æ‚¨çš„ä¿¡ç”¨ç­‰çº§æ”¯æŒæš‚ç¼“ä»˜æ¬¾ã€‚æš‚ç¼“ä»˜æ¬¾çš„è®¢å•å¯ä»¥éšæ—¶åœ¨"æˆ‘çš„è®¢å•"ä¸­æ”¯ä»˜ã€‚
  {% else %}
    æ‚¨å½“å‰æ˜¯{{ customer.levelid.levelid }}çº§ä¼šå‘˜ï¼Œæš‚ä¸æ”¯æŒæš‚ç¼“ä»˜æ¬¾åŠŸèƒ½ã€‚
  {% endif %}
</p>
{% endblock %}