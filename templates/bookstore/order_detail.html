{% extends "bookstore/base.html" %}
{% block content %}
<h2>订单详情：{{ order.orderno }}</h2>

<div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
  <p><strong>订单状态：</strong>
    {% if order.status == 0 %}
      <span style="color: #f39c12;">已下单</span>
    {% elif order.status == 1 %}
      <span style="color: #3498db;">已发货</span>
    {% elif order.status == 2 %}
      <span style="color: #27ae60;">已完成</span>
    {% elif order.status == 4 %}
      <span style="color: #95a5a6;">已取消</span>
    {% else %}未知状态
    {% endif %}
  </p>
  
  <p><strong>付款状态：</strong>
    {% if order.paymentstatus == 0 %}
      <span style="color: #e74c3c;">未支付</span>
    {% elif order.paymentstatus == 1 %}
      <span style="color: #27ae60;">已全额支付</span>
    {% elif order.paymentstatus == 2 %}
      <span style="color: #f39c12;">待补款</span>
    {% elif order.paymentstatus == 3 %}
      <span style="color: #7f8c8d;">已退款</span>
    {% endif %}
  </p>
  
  <p><strong>应付金额：</strong>¥{{ order.totalamount|floatformat:2 }}</p>
  <p><strong>实付金额：</strong>
    {% if order.actualpaid > 0 %}
    <span style="font-weight: bold; color: #27ae60;">
      ¥{{ order.actualpaid|floatformat:2 }}
    </span>
    {% else %}
    <span style="font-weight: bold;">
      ¥{{ order.actualpaid|floatformat:2 }}
    </span>
    {% endif %}
  </p>
  
  <p><strong>下单时间：</strong>{{ order.orderdate }}</p>
  <p><strong>收货地址：</strong>{{ order.shipaddress }}</p>
</div>

{% if customer %}
  <p><strong>会员等级：</strong>{{ customer.levelid.levelid }}级（{{ discount_percent|floatformat:0 }}% 折扣）</p>
{% endif %}

<h3>订单明细</h3>
<table border="1" cellpadding="10" style="width: 100%; border-collapse: collapse;">
  <thead>
    <tr>
      <th>图书</th>
      <th>ISBN</th>
      <th>数量</th>
      <th>单价</th>
      <th>原始小计</th>
      <th>折扣后小计</th>
    </tr>
  </thead>
  <tbody>
    {% for item in details_with_discount %}
      <tr>
        <td>{{ item.detail.isbn.title }}</td>
        <td>{{ item.detail.isbn.isbn }}</td>
        <td>{{ item.detail.quantity }}</td>
        <td>¥{{ item.detail.unitprice }}</td>
        <td>¥{{ item.original_item_amount|floatformat:2 }}</td>
        <td><strong>¥{{ item.discounted_item_amount|floatformat:2 }}</strong></td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="6">暂无订单详情</td>
      </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <td colspan="4"><strong>合计</strong></td>
      <td>¥{{ original_amount|floatformat:2 }}</td>
      <td><strong>¥{{ order.totalamount|floatformat:2 }}</strong></td>
    </tr>
    <tr>
      <td colspan="4"><strong>节省金额</strong></td>
      <td colspan="2" style="color: green;"><strong>¥{{ discount_amount|floatformat:2 }}</strong></td>
    </tr>
  </tfoot>
</table>

<!-- 操作按钮 -->
<div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
  <h3 style="margin-top: 0;">操作</h3>
  
  <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
    <!-- 取消订单按钮（未发货且未取消的订单） -->
    {% if order.status == 0 %}
    <form method="post" action="{% url 'bookstore:cancel_order' order.orderid %}" style="display: inline;">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger"
              onclick="return confirm('确定要取消这个订单吗？\n\n取消后订单将无法恢复。')">
        取消订单
      </button>
    </form>
    {% endif %}

    <!-- 补足支付按钮（未全额支付订单） -->
    {% if order.paymentstatus == 2 and order.status != 4 %}
    <form method="post" action="{% url 'bookstore:pay_order' order.orderid %}" style="display: inline;">
      {% csrf_token %}
      {% with unpaid=order.totalamount|add:"-"|add:order.actualpaid %}
      <button type="submit" class="btn btn-warning"
              onclick="return confirm('补足支付 ¥{{ unpaid }} 吗？\n\n需要从余额扣款，余额不足则无法支付。\n\n支付后您的累计消费将增加，可能会提升信用等级。')">
              补足支付 ¥{{ unpaid|floatformat:2 }}（已付¥{{ order.actualpaid|floatformat:2 }}）
      </button>
      {% endwith %}
    </form>
    {% endif %}

    <!-- 确认收货按钮（已发货订单） -->
    {% if order.status == 1 %}
    <form method="post" action="{% url 'bookstore:confirm_receipt' order.orderid %}" style="display: inline;">
      {% csrf_token %}
      <button type="submit" class="btn btn-primary"
              onclick="return confirm('确认收货吗？\n\n确认后订单将标记为已完成。')">
        确认收货
      </button>
    </form>
    {% endif %}
    
    <a href="{% url 'bookstore:order_list' %}" class="btn">返回订单列表</a>
  </div>
  
  {% if order.paymentstatus == 0 %}
  <p style="color: #e74c3c; margin-top: 1rem; margin-bottom: 0; font-size: 0.9rem;">
    ⚠️ 提示：此订单尚未付款，请尽快支付以完成订单。
  </p>
  {% endif %}
</div>
{% endblock %}