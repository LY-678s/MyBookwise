{% extends "bookstore/base.html" %}
{% block content %}
<h2>è®¢å•è¯¦æƒ…ï¼š{{ order.orderno }}</h2>

<div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
  <p><strong>è®¢å•çŠ¶æ€ï¼š</strong>
    {% if order.status == 0 %}
      <span style="color: #f39c12;">â³ å·²ä¸‹å•</span>
    {% elif order.status == 1 %}
      <span style="color: #3498db;">ğŸšš å·²å‘è´§</span>
    {% elif order.status == 2 %}
      <span style="color: #27ae60;">âœ“ å·²å®Œæˆ</span>
    {% elif order.status == 4 %}
      <span style="color: #95a5a6;">âœ— å·²å–æ¶ˆ</span>
    {% else %}æœªçŸ¥çŠ¶æ€
    {% endif %}
  </p>
  
  <p><strong>ä»˜æ¬¾çŠ¶æ€ï¼š</strong>
    {% if order.paymentstatus == 0 %}
      <span style="color: #e74c3c;">âŒ æœªæ”¯ä»˜</span>
    {% elif order.paymentstatus == 1 %}
      <span style="color: #27ae60;">âœ“ å·²å…¨é¢æ”¯ä»˜</span>
    {% elif order.paymentstatus == 2 %}
      <span style="color: #f39c12;">â³ å¾…è¡¥æ¬¾</span>
    {% elif order.paymentstatus == 3 %}
      <span style="color: #7f8c8d;">å·²é€€æ¬¾</span>
    {% endif %}
  </p>
  
  <p><strong>åº”ä»˜é‡‘é¢ï¼š</strong>Â¥{{ order.totalamount|floatformat:2 }}</p>
  <p><strong>å®ä»˜é‡‘é¢ï¼š</strong>
    <span style="font-weight: bold; {% if order.actualpaid > 0 %}color: #27ae60;{% endif %}">
      Â¥{{ order.actualpaid|floatformat:2 }}
    </span>
  </p>
  
  <p><strong>ä¸‹å•æ—¶é—´ï¼š</strong>{{ order.orderdate }}</p>
  <p><strong>æ”¶è´§åœ°å€ï¼š</strong>{{ order.shipaddress }}</p>
</div>

{% if customer %}
  <p><strong>ä¼šå‘˜ç­‰çº§ï¼š</strong>{{ customer.levelid.levelid }}çº§ï¼ˆ{{ discount_percent|floatformat:0 }}% æŠ˜æ‰£ï¼‰</p>
{% endif %}

<h3>è®¢å•æ˜ç»†</h3>
<table border="1" cellpadding="10" style="width: 100%; border-collapse: collapse;">
  <thead>
    <tr>
      <th>å›¾ä¹¦</th>
      <th>ISBN</th>
      <th>æ•°é‡</th>
      <th>å•ä»·</th>
      <th>åŸå§‹å°è®¡</th>
      <th>æŠ˜æ‰£åå°è®¡</th>
    </tr>
  </thead>
  <tbody>
    {% for item in details_with_discount %}
      <tr>
        <td>{{ item.detail.isbn.title }}</td>
        <td>{{ item.detail.isbn.isbn }}</td>
        <td>{{ item.detail.quantity }}</td>
        <td>Â¥{{ item.detail.unitprice }}</td>
        <td>Â¥{{ item.original_item_amount|floatformat:2 }}</td>
        <td><strong>Â¥{{ item.discounted_item_amount|floatformat:2 }}</strong></td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="6">æš‚æ— è®¢å•è¯¦æƒ…</td>
      </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <td colspan="4"><strong>åˆè®¡</strong></td>
      <td>Â¥{{ original_amount|floatformat:2 }}</td>
      <td><strong>Â¥{{ order.totalamount|floatformat:2 }}</strong></td>
    </tr>
    <tr>
      <td colspan="4"><strong>èŠ‚çœé‡‘é¢</strong></td>
      <td colspan="2" style="color: green;"><strong>Â¥{{ discount_amount|floatformat:2 }}</strong></td>
    </tr>
  </tfoot>
</table>

<!-- æ“ä½œæŒ‰é’® -->
<div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
  <h3 style="margin-top: 0;">æ“ä½œ</h3>
  
  <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
    <!-- è¡¥è¶³æ”¯ä»˜æŒ‰é’®ï¼ˆæœªå…¨é¢æ”¯ä»˜è®¢å•ï¼‰ -->
    {% if order.paymentstatus == 2 and order.status != 4 %}
    <form method="post" action="{% url 'bookstore:pay_order' order.orderid %}" style="display: inline;">
      {% csrf_token %}
      {% with unpaid=order.totalamount|add:"-"|add:order.actualpaid %}
      <button type="submit" class="btn btn-warning" 
              onclick="return confirm('è¡¥è¶³æ”¯ä»˜ Â¥{{ unpaid }} å—ï¼Ÿ\n\néœ€è¦ä»ä½™é¢æ‰£æ¬¾ï¼Œä½™é¢ä¸è¶³åˆ™æ— æ³•æ”¯ä»˜ã€‚\n\næ”¯ä»˜åæ‚¨çš„ç´¯è®¡æ¶ˆè´¹å°†å¢åŠ ï¼Œå¯èƒ½ä¼šæå‡ä¿¡ç”¨ç­‰çº§ã€‚')">
        ğŸ’° è¡¥è¶³æ”¯ä»˜ Â¥{{ unpaid|floatformat:2 }}ï¼ˆå·²ä»˜Â¥{{ order.actualpaid|floatformat:2 }}ï¼‰
      </button>
      {% endwith %}
    </form>
    {% endif %}
    
    <!-- ç¡®è®¤æ”¶è´§æŒ‰é’®ï¼ˆå·²å‘è´§è®¢å•ï¼‰ -->
    {% if order.status == 1 %}
    <form method="post" action="{% url 'bookstore:confirm_receipt' order.orderid %}" style="display: inline;">
      {% csrf_token %}
      <button type="submit" class="btn btn-primary"
              onclick="return confirm('ç¡®è®¤æ”¶è´§å—ï¼Ÿ\n\nç¡®è®¤åè®¢å•å°†æ ‡è®°ä¸ºå·²å®Œæˆã€‚')">
        ğŸ“¦ ç¡®è®¤æ”¶è´§
      </button>
    </form>
    {% endif %}
    
    <a href="{% url 'bookstore:order_list' %}" class="btn">è¿”å›è®¢å•åˆ—è¡¨</a>
  </div>
  
  {% if order.paymentstatus == 0 %}
  <p style="color: #e74c3c; margin-top: 1rem; margin-bottom: 0; font-size: 0.9rem;">
    âš ï¸ æç¤ºï¼šæ­¤è®¢å•å°šæœªä»˜æ¬¾ï¼Œè¯·å°½å¿«æ”¯ä»˜ä»¥å®Œæˆè®¢å•ã€‚
  </p>
  {% endif %}
</div>
{% endblock %}