# 订单支付逻辑说明（简化版）

## 📊 表结构总结

### Orders表（订单主表）

| 字段 | 类型 | 说明 |
|------|------|------|
| OrderID | int | 订单ID |
| OrderNo | varchar(30) | 订单号 |
| OrderDate | datetime | 下单日期 |
| CustomerID | int | 客户ID |
| ShipAddress | varchar(200) | 配送地址 |
| **TotalAmount** | decimal(10,2) | **应付金额（折扣后）** ✅ |
| **PaymentStatus** | tinyint | **付款状态：0=未付款, 1=已付款** ✅ 新增 |
| Status | tinyint | 订单状态：0=已下单, 1=已发货, 2=已完成, 4=已取消 |

### OrderDetail表（订单明细）

| 字段 | 类型 | 说明 |
|------|------|------|
| DetailID | int | 明细ID |
| OrderID | int | 订单ID |
| ISBN | varchar(20) | 图书ISBN |
| Quantity | int | 数量 |
| UnitPrice | decimal(10,2) | 单价（原价） |
| IsShipped | tinyint | 是否已发货：0=未发货, 1=已发货 |

**支持一个订单多本书**：
- 一个OrderID对应多条明细记录
- 每条明细一本书

### Customer表（客户）

| 字段 | 类型 | 说明 |
|------|------|------|
| Balance | decimal(10,2) | 账户余额 |
| LevelID | int | 信用等级 (1-5级) |
| OverdraftLimit | decimal(10,2) | 透支额度上限 |
| **CurrentOverdraft** | decimal(10,2) | **当前已透支金额** ✅ 新增 |
| TotalSpent | decimal(12,2) | 累计消费 |

---

## 💰 简化的付款逻辑

### 下单流程

```
1. 顾客加入购物车（多本书）
   ↓
2. 确认订单
   ↓
3. 计算应付金额 = Σ(单价 × 数量) × 信用等级折扣率
   ↓
4. 检查余额和透支额度
   ├─ 1-2级会员：余额不足 → 提示充值 ❌
   └─ 3-5级会员：
      ├─ 余额充足 → 直接扣款 ✅
      └─ 余额不足 → 检查透支额度
         ├─ 不超额度 → 扣款（balance为负数）✅
         └─ 超出额度 → 提示充值 ❌
   ↓
5. 创建订单
   ├─ PaymentStatus = 1（已付款）
   ├─ Status = 0（已下单）
   └─ 扣除库存
   ↓
6. 清空购物车
```

### 付款状态说明

**PaymentStatus = 1（已付款）**包括：
- ✅ 余额充足，正常扣款
- ✅ 余额不足，使用透支额度扣款（balance变为负数）

**PaymentStatus = 0（未付款）**：
- ❌ 本项目不使用（简化处理）

---

## 🔢 透支金额计算

### CurrentOverdraft（当前已透支金额）

**定义：** 账户余额为负数时的绝对值

```python
if balance < 0:
    current_overdraft = abs(balance)  # 绝对值
else:
    current_overdraft = 0
```

**示例：**
- 余额 = 1000元 → CurrentOverdraft = 0
- 余额 = -200元 → CurrentOverdraft = 200元（已透支200）
- 余额 = -500元, 透支限额500 → 已用满，不能再透支

### 约束检查

```sql
CHECK (CurrentOverdraft >= 0)
CHECK (CurrentOverdraft <= OverdraftLimit)
CHECK (Balance >= -OverdraftLimit)
```

---

## 📋 信用等级规则

| 等级 | 折扣率 | 可透支 | 透支额度 | 说明 |
|------|--------|--------|---------|------|
| 1级 | 0.9 (10%折) | ❌ 否 | 0元 | 余额不足不能下单 |
| 2级 | 0.85 (15%折) | ❌ 否 | 0元 | 余额不足不能下单 |
| 3级 | 0.85 (15%折) | ✅ 是 | 500元 | 可透支最多500元 |
| 4级 | 0.80 (20%折) | ✅ 是 | 1000元 | 可透支最多1000元 |
| 5级 | 0.75 (25%折) | ✅ 是 | 99999999元 | 几乎无限透支 |

---

## 🔄 业务流程示例

### 示例1：1级会员下单（必须余额充足）

**张三（1级会员，余额714.70元，不可透支）**

```
购买Python书 × 2本 = 89 × 2 = 178元
折扣后 = 178 × 0.9 = 160.20元

检查：
✅ 余额714.70 >= 160.20 → 可以下单
✅ 扣款后余额 = 714.70 - 160.20 = 554.50元
✅ CurrentOverdraft = 0（未透支）
```

### 示例2：3级会员透支下单

**李四（3级会员，余额100元，可透支500元）**

```
购买书籍，应付300元
折扣后 = 300 × 0.85 = 255元

检查：
✅ 余额100 < 255，但可透支
✅ 透支金额 = 255 - 100 = 155元
✅ 155 < 500（透支限额）→ 可以下单
✅ 扣款后余额 = 100 - 255 = -155元
✅ CurrentOverdraft = 155元
```

### 示例3：超出透支额度

**李四（3级会员，余额100元，可透支500元）**

```
购买书籍，应付800元
折扣后 = 800 × 0.85 = 680元

检查：
❌ 余额100 < 680
❌ 透支金额 = 680 - 100 = 580元
❌ 580 > 500（透支限额）→ 不能下单！
❌ 提示：余额不足，超出透支额度，请充值
```

---

## 🎯 Admin后台管理

### Orders（订单）

**可以做的操作：**
- ✅ 查看订单列表
- ✅ 查看订单详情（含订单明细）
- ✅ 修改订单状态（发货、完成、取消）
- ✅ 批量发货、批量完成

**不能做的操作：**
- ❌ 创建新订单（必须通过客户端下单）

### OrderDetail（订单明细）

**集成到Orders中显示**（使用Inline）
- 一个订单下显示所有明细
- 可以标记发货状态

### Procurement（采购单）+ ProcurementDetail（采购明细）

**同样合并显示**（使用Inline）

---

## 🚀 实现步骤

### 1. 运行SQL更新数据库 ✅

```sql
USE bookstoredb;
SOURCE D:/Engineering/MyBookwise/SetDatabase/setdatabase.sql;
```

### 2. 更新Django模型 ⏭️ 下一步

- 添加 `paymentstatus` 字段到 Orders模型
- 添加 `currentoverdraft` 字段到 Customer模型

### 3. 修改Admin界面 ⏭️ 下一步

- 使用 InlineModelAdmin 嵌入orderdetail到orders
- 禁用orders的添加功能

### 4. 修改下单逻辑 ⏭️ 下一步

- 检查透支额度
- 计算CurrentOverdraft
- 设置PaymentStatus

---

需要我继续实施后续步骤吗？

