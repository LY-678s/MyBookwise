# 订单支付系统改动进度

## ✅ 已完成的改动（第一阶段）

### 1. 数据库表结构 ✅

#### Orders表
- ✅ 添加 `ActualPaid` 字段（实付金额）
- ✅ 修改 `PaymentStatus` 字段值范围：0=未付款, 1=已付款, 2=已退款
- ✅ 添加约束：`ActualPaid <= TotalAmount`

#### Customer表
- ✅ 添加 `CurrentOverdraft` 字段（当前透支金额）
- ✅ 添加约束：`CurrentOverdraft <= OverdraftLimit`

### 2. Django模型更新 ✅

- ✅ Orders模型：添加 `actualpaid`字段
- ✅ Customer模型：添加 `currentoverdraft` 字段

### 3. Admin后台优化 ✅

- ✅ **订单明细内嵌显示**（OrderdetailInline）
- ✅ **采购明细内嵌显示**（ProcurementdetailInline）
- ✅ **禁止创建订单**（`has_add_permission = False`）
- ✅ 隐藏独立的订单明细和采购明细页面
- ✅ 订单列表显示：应付金额、实付金额、付款状态
- ✅ 客户列表显示：当前透支金额

### 4. 客户端新功能 ✅

#### 账户管理页面（/account/）
- ✅ 显示账户信息（余额、透支、累计消费、信用等级）
- ✅ **充值功能**：输入金额，立即到账
- ✅ **偿还透支功能**：一键偿还全部透支（增加TotalSpent）
- ✅ 信用等级说明表格

#### URL路由
- ✅ `/account/` - 账户管理页面
- ✅ `/account/repay/` - 偿还透支
- ✅ `/orders/<id>/pay/` - 支付未付款订单

#### 导航栏
- ✅ 添加"我的账户"链接

### 5. 信号处理逻辑重构 ✅

- ✅ 添加 `process_payment()` 函数：处理付款、检查透支额度
- ✅ 修改退款逻辑：只退还ActualPaid，减少TotalSpent
- ✅ 修改订单完成逻辑：不再更新TotalSpent（付款时已更新）

---

## ⏭️ 待完成的改动（第二阶段）

### 1. 修改下单流程 ⏭️ 进行中

**需要修改 `order_confirm` 视图**：
- ⏭️ 添加付款方式选择（立即付款 / 暂缓付款）
- ⏭️ 1-2级会员：只能立即付款
- ⏭️ 3-5级会员：可选择暂缓付款
- ⏭️ 立即付款：调用 `process_payment()` 扣款
- ⏭️ 暂缓付款：PaymentStatus=0，不扣款

**需要修改 `order_confirm.html` 模板**：
- ⏭️ 添加付款方式选择单选框
- ⏭️ 显示可用透支额度
- ⏭️ 实时计算是否超出透支限额

### 2. 修改订单详情页 ⏭️ 待办

**需要修改 `order_detail.html` 模板**：
- ⏭️ 显示付款状态和实付金额
- ⏭️ 未付款订单显示"立即支付"按钮
- ⏭️ 已发货订单显示"确认收货"按钮

**需要添加 `confirm_receipt` 视图**：
- ⏭️ 顾客确认收货
- ⏭️ 订单status从1变为2

### 3. 自动确认收货（可选）⏭️ 待办

- ⏭️ 添加发货时间字段
- ⏭️ 添加定时任务（Celery或management command）
- ⏭️ 发货N天后自动确认收货

---

## 🎯 新的业务流程

### 下单流程（立即付款）
```
1. 选择图书 → 加入购物车
2. 确认订单 → 选择"立即付款"
3. 检查余额和透支额度
   ├─ 余额充足 → 扣款 ✅
   ├─ 余额不足 + 可透支 → 透支扣款 ✅
   └─ 超出透支额度 → 提示充值 ❌
4. 创建订单：
   - TotalAmount = 应付金额
   - ActualPaid = 应付金额
   - PaymentStatus = 1（已付款）
   - Status = 0（已下单）
5. 更新客户：
   - Balance -= 应付金额
   - TotalSpent += 应付金额 ⭐
   - CurrentOverdraft = abs(Balance) if Balance < 0
6. 清空购物车
```

### 下单流程（暂缓付款，仅3-5级）
```
1. 选择图书 → 加入购物车
2. 确认订单 → 选择"暂缓付款"
3. 检查透支额度：
   - 应付金额 <= 可用透支额度 → 允许 ✅
   - 应付金额 > 可用透支额度 → 提示充值或立即付款 ❌
4. 创建订单：
   - TotalAmount = 应付金额
   - ActualPaid = 0（未付款）
   - PaymentStatus = 0（未付款）
   - Status = 0（已下单）
5. 不扣款，不更新TotalSpent
6. 清空购物车
```

### 支付未付款订单
```
1. 我的订单 → 找到未付款订单
2. 点击"立即支付"
3. 与立即付款流程相同
4. 更新订单：
   - ActualPaid = TotalAmount
   - PaymentStatus = 1
5. 更新客户：Balance、TotalSpent、CurrentOverdraft
```

### 偿还透支
```
1. 我的账户 → 点击"偿还透支"
2. 余额 += CurrentOverdraft
3. TotalSpent += CurrentOverdraft ⭐（关键！）
4. CurrentOverdraft = 0
5. 可能升级信用等级
```

### 订单取消（退款）
```
1. 管理员取消订单（status变为4）
2. 如果已付款（PaymentStatus=1）：
   - Balance += ActualPaid（退款）
   - TotalSpent -= ActualPaid
   - PaymentStatus = 2（已退款）
   - 可能降级信用等级
3. 如果未付款（PaymentStatus=0）：
   - 不需要退款
```

---

## 🚀 接下来要做的

1. **修改order_confirm视图**：添加付款方式选择
2. **修改order_confirm.html模板**：添加付款选项UI
3. **修改order_detail.html模板**：添加支付和确认收货按钮
4. **添加confirm_receipt视图**：确认收货功能
5. **测试完整流程**

---

## 📝 测试场景

### 场景1：立即付款（余额充足）
- 张三（1级，余额714.70）买89元的书
- 选择立即付款 → 成功
- 余额变为625.70，TotalSpent增加80.10

### 场景2：立即付款（需要透支）
- 李四（3级，余额2422.80）买3000元的书
- 折扣后2550元，余额不足
- 透支127.20元 < 500元限额 → 成功
- 余额变为-127.20，CurrentOverdraft=127.20，TotalSpent增加2550

### 场景3：暂缓付款
- 李四买100元的书，选择暂缓付款
- 订单创建，PaymentStatus=0，ActualPaid=0
- 余额不变，TotalSpent不变
- 后续可以支付

### 场景4：偿还透支
- 李四透支127.20元
- 点击"偿还透支" → Balance从-127.20变为0
- TotalSpent += 127.20
- 可能升级

---

**当前进度：约60%完成**

需要我继续完成剩余功能吗？

