# 测试数据逻辑说明

## 📊 数据逻辑规则

### TotalSpent（累计消费）计算规则

**只有实际支付的金额才计入累计消费：**

1. ✅ **已付款订单**（PaymentStatus=1）：TotalSpent += ActualPaid
2. ❌ **未付款订单**（PaymentStatus=0）：不计入TotalSpent
3. ❌ **已退款订单**（PaymentStatus=2，取消后）：已从TotalSpent中减去

### Balance（余额）计算规则

**只有PaymentStatus=1的订单才扣款：**

1. ✅ **已付款订单**：Balance -= ActualPaid
2. ❌ **未付款订单**：余额不变
3. ✅ **已退款订单**：已退回余额

---

## 👥 三个测试客户的完整数据

### 张三（CustomerID=1）

**基本信息：**
- 初始余额：1000.00元
- 信用等级：1级（不可透支，0.9折扣）
- OverdraftLimit：0元
- CurrentOverdraft：0元

**订单记录：**

| 订单 | 金额 | ActualPaid | PaymentStatus | Status | 说明 |
|------|------|-----------|--------------|--------|------|
| 订单1 | 125.10 | 125.10 | 2（已退款） | 4（已取消） | 已退款，不计入TotalSpent |
| 订单4 | 160.20 | 160.20 | 1（已付款） | 0（已下单） | ✅ 计入TotalSpent |
| 订单6 | 125.10 | 125.10 | 1（已付款） | 0（已下单） | ✅ 计入TotalSpent |

**最终状态：**
- Balance：1000 - 160.20 - 125.10 = **714.70元** ✅
- TotalSpent：0 + 160.20 + 125.10 = **285.30元** ✅
- 等级：1级（未达1000元）

---

### 李四（CustomerID=2）

**基本信息：**
- 初始余额：5000.00元
- 初始累计消费：2500.00元
- 信用等级：4级（原3级，应升级）
- OverdraftLimit：1000元（升级后）
- CurrentOverdraft：0元

**订单记录：**

| 订单 | 金额 | ActualPaid | PaymentStatus | Status | 说明 |
|------|------|-----------|--------------|--------|------|
| 订单2 | 2425.90 | 2425.90 | 2（已退款） | 4（已取消） | 已退款，不计入 |
| 订单3 | 2577.20 | 2577.20 | 1（已付款） | 0（已下单） | ✅ 计入，测试用 |
| 订单7 | 83.30 | 0.00 | 0（未付款） | 0（已下单） | ❌ 未付款，测试暂缓付款 |

**最终状态：**
- Balance：5000 - 2577.20 = **2422.80元** ✅
- TotalSpent：2500 + 2577.20 = **5077.20元** ✅
- 等级：**4级**（≥5000元，已升级）✅
- 可测试场景：
  - ⭐ 支付订单7（未付款订单支付）
  - ⭐ 完成订单3（验证TotalSpent不重复增加）

---

### 王五（CustomerID=3）

**基本信息：**
- 初始余额：10000.00元
- 初始累计消费：6000.00元
- 信用等级：4级
- OverdraftLimit：1000元
- CurrentOverdraft：0元

**订单记录：**

| 订单 | 金额 | ActualPaid | PaymentStatus | Status | 说明 |
|------|------|-----------|--------------|--------|------|
| 订单5 | 307.20 | 307.20 | 1（已付款） | 1（已发货） | ✅ 计入 |
| 订单8 | 126.40 | 126.40 | 1（已付款） | 1（已发货） | ✅ 计入 |

**最终状态：**
- Balance：10000 - 307.20 - 126.40 = **9566.40元** ✅
- TotalSpent：6000 + 307.20 + 126.40 = **6433.60元** ✅
- 等级：4级（未达10000元）

---

## 🧪 测试场景设计

### 场景1：充值功能
**操作：** 张三充值200元
- Balance：714.70 + 200 = 914.70元
- TotalSpent：不变（285.30元）
- 等级：不变（1级）

### 场景2：支付未付款订单
**操作：** 李四支付订单7（83.30元）
- Balance：2422.80 - 83.30 = 2339.50元
- TotalSpent：5077.20 + 83.30 = 5160.50元
- 等级：不变（4级）
- PaymentStatus：0 → 1

### 场景3：透支购买（需要修改下单流程后测试）
**操作：** 张三买1000元的书（1级会员不能透支）
- 余额714.70元，折扣后900元
- 提示：余额不足，请充值

**操作：** 李四买3000元的书（4级会员可透支）
- 余额2422.80元，折扣后2550元（0.85折）
- 需要透支：2550 - 2422.80 = 127.20元
- 127.20 < 1000（透支限额）→ 允许
- Balance变为-127.20元
- CurrentOverdraft = 127.20元

### 场景4：偿还透支
**操作：** 李四偿还透支127.20元
- Balance：-127.20 + 127.20 = 0元
- TotalSpent：5077.20 + 127.20 = 5204.40元
- CurrentOverdraft：127.20 → 0元
- 等级：不变（4级）

### 场景5：订单取消退款
**操作：** 管理员取消订单3（李四，已付款2577.20元）
- PaymentStatus：1 → 2（已退款）
- Status：0 → 4（已取消）
- Balance：2422.80 + 2577.20 = 5000元
- TotalSpent：5077.20 - 2577.20 = 2500元
- 等级：4级 → 3级（<5000元，降级）

---

## 📋 数据一致性检查表

| 客户 | Balance | TotalSpent | LevelID | CurrentOverdraft | 逻辑 |
|------|---------|-----------|---------|-----------------|------|
| 张三 | 714.70 | **285.30** ✅ | 1 | 0 | 已付订单4+6 |
| 李四 | 2422.80 | **5077.20** ✅ | **4** ✅ | 0 | 初始2500+订单3，≥5000升4级 |
| 王五 | 9566.40 | **6433.60** ✅ | 4 | 0 | 初始6000+订单5+8 |

---

## 🎯 测试重点

### 必测功能
- [ ] 充值功能（张三充值）
- [ ] 支付未付款订单（李四支付订单7）
- [ ] 偿还透支（需要先测试透支购买）
- [ ] 订单取消退款（取消订单3，验证降级）
- [ ] 信用等级自动升级（数据已验证）

### 验证点
- [ ] TotalSpent只在付款时增加
- [ ] 订单完成不重复增加TotalSpent
- [ ] 偿还透支也增加TotalSpent
- [ ] 退款正确减少TotalSpent

---

**数据已修正！重新运行SQL即可使用。**

