# MyBookwise 网上书店 - 完整功能清单

## ✅ 已完成的所有功能

### 🗄️ 数据库层（MySQL）

#### 表结构
- ✅ 11个业务表（Book, Customer, Orders等）
- ✅ 10个Django框架表
- ✅ 新增字段：
  - Orders.ActualPaid（实付金额）
  - Orders.PaymentStatus（0=未付款, 1=已付款, 2=已退款）
  - Customer.CurrentOverdraft（当前透支金额）

#### 触发器（13个仍在工作）
- ✅ 库存管理触发器
- ✅ 订单金额计算触发器
- ✅ 采购管理触发器
- ✅ 发货状态自动更新触发器
- ⚠️ 4个触发器已禁用（由Django信号替代）

#### 存储过程（7个）
- ✅ 创建订单、处理发货、采购管理等

#### 视图（3个）
- ✅ 图书目录、客户订单、库存预警

---

### 💻 Django后端

#### 模型（11个）
- ✅ 所有模型添加中文verbose_name
- ✅ 支持新增字段

#### 视图函数（18个）

**公共功能：**
- ✅ index - 首页图书列表
- ✅ book_detail - 图书详情
- ✅ search - 搜索图书

**认证：**
- ✅ customer_login - 客户登录
- ✅ customer_logout - 客户注销
- ✅ customer_required - 登录装饰器

**购物车：**
- ✅ cart_detail - 查看购物车（显示折扣）
- ✅ cart_add - 加入购物车
- ✅ cart_remove - 移除商品

**订单：**
- ✅ order_confirm - 订单确认（支持立即付款/暂缓付款）
- ✅ order_list - 我的订单列表
- ✅ order_detail - 订单详情
- ✅ pay_order - 支付未付款订单 ⭐
- ✅ confirm_receipt - 确认收货 ⭐

**账户：**
- ✅ account_recharge - 账户充值 ⭐
- ✅ repay_overdraft - 偿还透支 ⭐

#### 信号处理（2个）
- ✅ Shortagerecord信号 - 自动生成采购单
- ✅ Orders信号 - 处理退款、信用等级
- ✅ process_payment函数 - 处理付款和透支检查 ⭐

---

### 🎨 前台页面（10个）

#### 基础页面
- ✅ base.html - 基础模板（导航栏、消息提示）
- ✅ index.html - 首页图书列表
- ✅ book_detail.html - 图书详情
- ✅ search.html - 搜索结果

#### 认证页面
- ✅ login.html - 登录页面

#### 购物流程
- ✅ cart.html - 购物车（显示折扣）
- ✅ order_confirm.html - 订单确认（付款方式选择）⭐
- ✅ order_list.html - 订单列表（显示付款状态）⭐
- ✅ order_detail.html - 订单详情（支付/确认收货按钮）⭐

#### 账户管理
- ✅ account.html - 账户管理（充值/偿还透支）⭐

---

### 🔧 管理后台

#### 注册的模型管理（9个）
- ✅ Book - 图书管理
- ✅ Bookauthor - 图书作者
- ✅ Creditlevel - 信用等级
- ✅ Customer - 客户管理（显示透支金额）⭐
- ✅ Orders - 订单管理（内嵌订单明细，禁止创建）⭐
- ✅ Procurement - 采购单（内嵌采购明细）⭐
- ✅ Shortagerecord - 缺货记录
- ✅ Supplier - 供应商
- ✅ Supplierbook - 供应商图书

#### 内联管理（2个）
- ✅ OrderdetailInline - 订单明细内嵌显示 ⭐
- ✅ ProcurementdetailInline - 采购明细内嵌显示 ⭐

#### 特色功能
- ✅ 批量操作（发货、完成、取消）
- ✅ 库存检查
- ✅ 禁止创建订单（必须从客户端）⭐
- ✅ 订单状态保护（已取消不可恢复）

---

## 🎯 核心业务逻辑

### 💰 付款逻辑

#### 下单时选择立即付款
```
1. 计算应付金额（含折扣）
2. 检查余额和透支额度
   ├─ 1-2级：余额不足 → 提示充值 ❌
   └─ 3-5级：余额不足 → 使用透支
      ├─ 不超限 → 允许 ✅
      └─ 超限 → 提示充值 ❌
3. 扣款：
   - Balance -= TotalAmount
   - CurrentOverdraft = abs(Balance) if Balance < 0
   - TotalSpent += TotalAmount ⭐
4. 更新订单：
   - ActualPaid = TotalAmount
   - PaymentStatus = 1
5. 可能升级信用等级
```

#### 下单时选择暂缓付款（仅3-5级）
```
1. 计算应付金额
2. 检查可用透支额度（OverdraftLimit - CurrentOverdraft）
   - TotalAmount <= 可用额度 → 允许 ✅
   - TotalAmount > 可用额度 → 拒绝 ❌
3. 不扣款，不更新TotalSpent
4. 订单状态：
   - ActualPaid = 0
   - PaymentStatus = 0（未付款）
5. 后续可以随时支付
```

#### 支付未付款订单
```
1. 与立即付款逻辑相同
2. 更新订单和客户数据
```

#### 偿还透支
```
1. Balance += CurrentOverdraft
2. TotalSpent += CurrentOverdraft ⭐（关键！）
3. CurrentOverdraft = 0
4. 可能升级信用等级
```

### 📦 订单状态流程

```
Status = 0 (已下单)
   ├─ PaymentStatus = 0 → 可以支付
   └─ PaymentStatus = 1 → 等待发货
        ↓ 管理员标记发货（所有明细isshipped=1）
Status = 1 (已发货)
   ↓ 顾客确认收货 或 自动确认
Status = 2 (已完成)
   ↓ 只能改为取消
Status = 4 (已取消)
   ├─ PaymentStatus = 2 (已退款)
   ├─ Balance += ActualPaid
   ├─ TotalSpent -= ActualPaid
   └─ 库存回补
```

### 🎖️ 信用等级系统

#### 升级规则
- TotalSpent ≥ 10000 → 5级
- TotalSpent ≥ 5000 → 4级
- TotalSpent ≥ 2000 → 3级
- TotalSpent ≥ 1000 → 2级
- 否则 → 1级

#### TotalSpent增加时机⭐
1. ✅ 付款时（立即付款或支付未付款订单）
2. ✅ 偿还透支时
3. ❌ 订单完成时（不再增加）

#### TotalSpent减少时机
1. ✅ 已付款订单取消退款时

---

## 🧪 测试场景

### 场景1：立即付款（余额充足）
- 张三（1级，余额714.70）买89元的书
- 选择立即付款 → 成功
- 余额变为625.70，TotalSpent变为374.30

### 场景2：立即付款（需要透支）
- 李四（4级，余额2422.80）买3000元的书
- 折扣后2550元（0.8折）
- 需透支127.20元 < 1000限额 → 成功
- Balance = -127.20，CurrentOverdraft = 127.20
- TotalSpent = 5077.20 + 2550 = 7627.20

### 场景3：暂缓付款
- 李四买200元的书，选择暂缓付款
- 检查：200 < (1000 - 0) → 允许
- 订单创建，PaymentStatus=0，不扣款

### 场景4：支付未付款订单
- 李四的订单7（83.30元，未付款）
- 点击"立即支付" → 扣款
- Balance = 2422.80 - 83.30 = 2339.50
- TotalSpent = 5077.20 + 83.30 = 5160.50

### 场景5：充值
- 张三充值200元
- Balance = 714.70 + 200 = 914.70
- TotalSpent不变

### 场景6：偿还透支
- 李四透支127.20元
- 点击"偿还透支" → Balance = 0，TotalSpent += 127.20

### 场景7：确认收货
- 王五的订单5（已发货）
- 点击"确认收货" → Status变为2

### 场景8：订单取消退款
- 管理员取消订单3（李四，已付2577.20）
- Balance += 2577.20
- TotalSpent -= 2577.20
- 可能降级

---

## 🚀 使用步骤

### 1. 运行SQL
```bash
USE bookstoredb;
SOURCE D:/Engineering/MyBookwise/SetDatabase/setdatabase.sql;
```

### 2. 重启Django
```bash
python manage.py runserver
```

### 3. 测试

#### 前台（http://127.0.0.1:8000/）
- 登录：lisi / pass456（李四，4级会员）
- 浏览图书 → 加入购物车
- 确认订单 → **选择付款方式**
- 我的订单 → 查看订单 → **支付未付款订单**
- 我的账户 → **充值**、**偿还透支**

#### 后台（http://127.0.0.1:8000/admin/）
- 登录：testadmin / admin123
- 订单管理 → 点击订单 → **查看内嵌的订单明细**
- 修改发货状态 → **自动变为已发货**
- 采购单 → 点击 → **查看内嵌的采购明细**

---

## 📊 功能完成度

| 模块 | 完成度 | 说明 |
|------|--------|------|
| 数据库设计 | 100% | 所有表、触发器、存储过程、视图 |
| Django模型 | 100% | 所有模型+中文名称 |
| 管理后台 | 100% | 内嵌显示、批量操作、权限控制 |
| **前台核心功能** | **95%** ⭐ | 浏览、下单、支付、充值、偿还 |
| **付款系统** | **100%** ⭐ | 立即付款、暂缓付款、透支管理 |
| 信用等级系统 | 100% | 自动升降级、折扣应用 |
| 订单管理 | 100% | 完整生命周期管理 |
| 库存管理 | 100% | 自动扣减、缺货提醒、自动采购 |

**总体完成度：约95%！** 🎉

---

## 🎯 亮点功能

1. ⭐ **立即付款/暂缓付款** - 根据信用等级灵活选择
2. ⭐ **透支管理** - 实时计算透支额度，支持偿还
3. ⭐ **实付金额追踪** - 避免透支后取消导致余额增加
4. ⭐ **信用等级自动升降** - 根据实际支付金额
5. ⭐ **订单明细内嵌** - Admin界面更直观
6. ⭐ **完整的订单生命周期** - 下单→付款→发货→确认→完成
7. ⭐ **权限控制** - 订单只能从客户端创建

---

**所有核心功能已完成！现在可以进行完整测试了！** 🚀

